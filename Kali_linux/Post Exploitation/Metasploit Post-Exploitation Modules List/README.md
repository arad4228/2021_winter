# Metasploit Post-Exploitation Modules  
Metasploit은 매우 광범위한 post-exploitation module 들을 가지고 있는데, 이들은 타겟을 위협하여 정보와 흔적을 수집하는 데 사용된다.  
타겟 네트워크의 중추로 더욱 깊게 파고들어간다. post-exploitation modules는 크게 세 가지 종류로 나눌 수 있다.  

- Escalate Group : 제한된 부분을 우회하거나 권한을 상승시키는 데 주로 사용되는 모듈들이 포함되어 있다.  
ex) Bypassuac, Getsystem  
- Gather Group : 가장 많은 모듈들이 포함되어 있다. 주로 공격당한 시스템에서 정보를 모으는 모듈들이 모여있다.  
ex) Enum_termsrv, Hashdump, Smart_hashdump
- Manage Group : 타겟 시스템의 환경설정을 바꿔버리는 모듈들이다.  
ex) Enable_RDP, Migrate, Smart_migrate  

### Window
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/window%EA%B4%80%EB%A0%A8.png)
### MacOsX
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/MacOsX%EA%B4%80%EB%A0%A8.png)
### Linux
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/Linux%EA%B4%80%EB%A0%A8.png)  
### Multi
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/multi(unixX)%EA%B4%80%EB%A0%A8.png)
사진에서 보다싶이 Unix는 따로 없다.  
이 이유는 unix와 linux가 어디부터 시작했는 지 안다면 이에 대한 의문은 풀릴 것이다.  

### 이를통해 post 모듈들은?
post 모듈은 운영체제별로 구성되어 있다.  
post/windows 모듈은 wlan, recon, manage, gather, escalate, capture 로 이루어져있다.  
post/linux 모듈은 post/windows 모듈만큼은 아니지만 어느정도 특정한 모듈들로 구성되어 있다.  
→ 이 post 모듈은 한가지 운영체제에서만 실행되는 것이 아니라 여러 운영체제에서 기능할 수 있다.  

## 모듈 사용 실습(Gathering Modules)
Windows 시스템에서의 Gathering Module인 'enum_termserv'는 이 머신에 원격 데스크탑 커넥션을 가진 머신들의 정보를 나열한다.  
만약 이 커맨드를 서버에서 사용한다면 권한을 가진 사용자들(시스템 관리자나 DB 관리자 등)을 발견할 수 있다.  

실제로 이 모듈은 타겟 시스템의 레지스트리를 들여다보고, 'HKEY_USERS/Software/Microsoft/Terminal Server Client'의 path로부터 key와 value들을 찾아 나열한다.  
우선 psexec을 이용한 Windows 8.1 대상의 meterpreter 세션을 열어준다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/%EC%8B%A4%EC%8A%B5%20%EC%A4%80%EB%B9%841.png)
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/%EC%8B%A4%EC%8A%B5%20%EC%A4%80%EB%B9%842.png)
이를 준비하는 과정은 우리가 PassTheHash를 진행하면서 사용했던 psexec를 통해 진행을 그대로 하면된다. 

**sysinfo**  
시스템 정보를 확인.  
**run post/windows/gather/enum_termserv**  
시스템이 원격으로 Win8.1에 연결된다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/%EC%8B%A4%EC%8A%B51.png)  
하지만 시스템이 원격으로 연결에 문제가 발생.  
이는 아마 window 8.1이나 내부 meterpreter가 올라가면서 변화가 있어 나타나는 문제일 수 있어 넘어가기로 하고 계속 실습을 진행한다.  
이는 추후에 인터넷을 통해 찾아보기로 한다.  

## 모듈 사용 실습(Managing Modules)
Manage group 에 속해있는 'enable_RDP' 모듈은 원격 데스크탑 서비스(Remote Desktop Service, RDP)를 가능하게 한다.  
계정을 생성하고 환경설정을 하여 이 계정이 로컬 관리자들의 하나인 것처럼 만든 후 데스크탑 사용자 그룹을 원격조정한다.  

'fDenyTSConnections'라는 레지스트리 값을 1로 만들어낸다.  
마찬가지로 meterpreter 세션에서 시작한다.  
**sysinfo**
**reg queryval -k "HKLM\\System\\CurrentControlSet\\Control\\Terminal Server" -v fDenyTSConnections**  
**이에 대한 사진은 위의 사진을 참고한다.**  
사진을 통해 Data 값이 1로 나오는 것을 확인할 수 있다.  
이는 타겟 시스템에서 원격 데스크탑 커넥션이 허용되지 않았다는 것이다.  
그렇다면 Windows 8.1로 가서 '나의 컴퓨터에 원격 액세스 허용'을 설정해준다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/%EC%8B%A4%EC%8A%B51%20%EC%84%A4%EC%A0%95.png)
그리고 Kali에서도 Windows 8.1에서 원격 액세스를 허용하도록 설정해준다. 

**run post/windows/manage/enable_rdp**  
**queryval -k "HKLM\\System\\CurrentControlSet\\Control\\Terminal Server" -v fDenyTSConnections**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/Metasploit%20Post-Exploitation%20Modules%20List/Source/%EC%8B%A4%EC%8A%B5%20%EC%99%84%EB%A3%8C.png)
를 하면 정상적으로 데이터 값이 0으로 변한 것을 볼 수 있다.
